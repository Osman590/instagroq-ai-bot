# bot_handlers.py
import os

from telegram import Update
from telegram.ext import ContextTypes

from bot_menu import main_menu
from bot_logging import send_log_http, build_start_log


# ---------- ENV ----------
MINIAPP_URL = (os.getenv("MINIAPP_URL") or "").strip()


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # 1) –ª–æ–≥ –≤ –≥—Ä—É–ø–ø—É
    send_log_http(build_start_log(update))

    # 2) –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    if update.effective_message:
        await update.effective_message.reply_text(
            "ü§ñ InstaGroq AI\n\n–í—ã–±–∏—Ä–∞–π –¥–µ–π—Å—Ç–≤–∏–µ –∫–Ω–æ–ø–∫–∞–º–∏ –Ω–∏–∂–µ üëá",
            reply_markup=main_menu(MINIAPP_URL),
        )


# –Ω–∞ —Å–ª—É—á–∞–π –≥—Ä—É–ø–ø: /start –∏–ª–∏ /start@BotUserName
async def start_from_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await start(update, context)


async def on_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data or ""

    if data == "miniapp_not_set":
        await query.message.reply_text(
            "‚ö†Ô∏è MINIAPP_URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.\n\n"
            "–î–æ–±–∞–≤—å –≤ Railway ‚Üí Variables:\n"
            "MINIAPP_URL = https://<—Ç–≤–æ–π-github-pages>"
        )
        return

    if data == "buy_pack":
        await query.message.reply_text(
            "‚≠ê –ü–∞–∫–µ—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π (–ø—Ä–∏–º–µ—Ä):\n"
            "‚Ä¢ 100 —Å–æ–æ–±—â–µ–Ω–∏–π ‚Äî 99‚ÇΩ\n"
            "‚Ä¢ 500 —Å–æ–æ–±—â–µ–Ω–∏–π ‚Äî 399‚ÇΩ\n"
            "‚Ä¢ 2000 —Å–æ–æ–±—â–µ–Ω–∏–π ‚Äî 999‚ÇΩ\n\n"
            "–û–ø–ª–∞—Ç—É –ø–æ–¥–∫–ª—é—á–∏–º –ø–æ–∑–∂–µ."
        )
        return

    if data == "settings":
        await query.message.reply_text("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è.")
        return

    if data == "help":
        await query.message.reply_text("‚ùì –ù–∞–∂–º–∏ ¬´–û—Ç–∫—Ä—ã—Ç—å Mini App¬ª –∏ –ø–∏—à–∏ –≤ —á–∞—Ç –≤–Ω—É—Ç—Ä–∏ Mini App.")
        return